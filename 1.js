// 获取DOM元素
const frontVideo = document.getElementById('frontVideo');
const backVideo = document.getElementById('backVideo');
const frontCanvas = document.getElementById('frontCanvas');
const backCanvas = document.getElementById('backCanvas');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const captureBtn = document.getElementById('captureBtn');
const frontCaptureBtn = document.getElementById('frontCaptureBtn');
const backCaptureBtn = document.getElementById('backCaptureBtn');
const statusText = document.getElementById('statusText');
const countText = document.getElementById('countText');
const guideText = document.getElementById('guideText');
const speakBtn = document.getElementById('speakBtn'); // 语音输出按钮
const pauseBtn = document.getElementById('pauseBtn'); // 暂停播报按钮

// 获取风格选择按钮
const humorBtn = document.getElementById('humorBtn');
const calmBtn = document.getElementById('calmBtn');
const academicBtn = document.getElementById('academicBtn');

// 初始化变量
let frontStream = null;
let backStream = null;
let photoCount = 0;
let selectedStyle = null; // 添加风格选择变量
let currentUtterance = null; // 当前语音对象
let isPaused = false; // 暂停状态标志

// ZhipuAI API Key
const API_KEY = "7a5ce9c3c9574ebfabf00d655ef0a759.u8GoanrbOGrUd2UP";

// 更新状态文本
function updateStatus(text) {
    statusText.textContent = `状态: ${text}`;
}

// 更新照片计数
function updateCount() {
    countText.textContent = `已拍摄照片: ${photoCount * 2}`;
}

// 风格选择处理
function selectStyle(style) {
    // 重置所有按钮状态
    humorBtn.classList.remove('active');
    calmBtn.classList.remove('active');
    academicBtn.classList.remove('active');

    // 设置选中按钮状态
    switch (style) {
        case 'humor':
            humorBtn.classList.add('active');
            break;
        case 'calm':
            calmBtn.classList.add('active');
            break;
        case 'academic':
            academicBtn.classList.add('active');
            break;
    }

    selectedStyle = style;
    updateStatus(`已选择风格: ${getStyleName(style)}`);
}

// 获取风格名称
function getStyleName(style) {
    switch (style) {
        case 'humor': return '幽默型';
        case 'calm': return '平静型';
        case 'academic': return '学术型';
        default: return '未选择';
    }
}

// 语音输出功能
function speakText(text) {
    // 移除HTML标签，只保留纯文本
    const cleanText = text.replace(/<[^>]*>/g, '');

    if ('speechSynthesis' in window) {
        // 停止当前正在播放的语音
        window.speechSynthesis.cancel();

        // 创建语音对象
        const utterance = new SpeechSynthesisUtterance(cleanText);
        currentUtterance = utterance;

        // 设置语音参数
        utterance.lang = 'zh-CN';
        utterance.rate = 1;
        utterance.pitch = 1;

        // 开始播放
        window.speechSynthesis.speak(utterance);
        isPaused = false;
        pauseBtn.textContent = '暂停播报';
        updateStatus('正在语音播报...');

        // 播放结束后的处理
        utterance.onend = () => {
            updateStatus('语音播报完成');
            currentUtterance = null;
        };
    } else {
        updateStatus('浏览器不支持语音功能');
    }
}

// 暂停/继续语音播报
function togglePauseSpeech() {
    if (!window.speechSynthesis) {
        updateStatus('浏览器不支持语音功能');
        return;
    }

    if (currentUtterance) {
        if (isPaused) {
            // 继续播放
            window.speechSynthesis.resume();
            isPaused = false;
            pauseBtn.textContent = '暂停播报';
            updateStatus('正在语音播报...');
        } else {
            // 暂停播放
            window.speechSynthesis.pause();
            isPaused = true;
            pauseBtn.textContent = '继续播报';
            updateStatus('语音播报已暂停');
        }
    }
}

// 启动摄像头
async function startCameras() {
    try {
        updateStatus('正在启动摄像头...');

        // 获取前置摄像头
        frontStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user' }
        });
        frontVideo.srcObject = frontStream;

        // 获取后置摄像头
        backStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
        });
        backVideo.srcObject = backStream;

        // 启用按钮
        startBtn.disabled = true;
        stopBtn.disabled = false;
        captureBtn.disabled = false;

        updateStatus('摄像头已启动');
    } catch (error) {
        console.error('获取摄像头失败:', error);
        updateStatus('获取摄像头失败: ' + error.message);
    }
}

// 停止摄像头
function stopCameras() {
    // 停止前置摄像头
    if (frontStream) {
        frontStream.getTracks().forEach(track => track.stop());
        frontStream = null;
    }

    // 停止后置摄像头
    if (backStream) {
        backStream.getTracks().forEach(track => track.stop());
        backStream = null;
    }

    // 禁用按钮
    startBtn.disabled = false;
    stopBtn.disabled = true;
    captureBtn.disabled = true;
    speakBtn.disabled = true; // 禁用语音按钮
    pauseBtn.disabled = true; // 禁用暂停按钮

    updateStatus('摄像头已停止');
}

// 拍照函数
function capturePhoto(video, canvas) {
    const context = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL('image/jpeg');
}

// 调用智谱AI API
async function callZhipuAPI(frontImageBase64, backImageBase64) {
    try {
        updateStatus('正在识别景点...');

        // 移除base64前缀
        const backImage = backImageBase64.replace('data:image/jpeg;base64,', '');

        // 第一步：识别景点
        const recognitionResponse = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: "glm-4.1v-thinking-flash",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "image_url",
                                image_url: {
                                    url: backImage
                                }
                            },
                            {
                                type: "text",
                                text: `你是上海交通大学的智能AI景点识别系统，你将跟据当前观察景点图片识别景点。
                                具体地，你将通过下列材料获取景点识别标准，并依据该标准和景点图片识别相应景点。
                                以下是识别标准：注意：一定要结合以下景点资料进行介绍。当你识别景点信息时，必须按照下列四个识别标准以识别景点。
                            
# 1. DQ冰淇淋店景观特证
- **核心结构**：现代风格的DQ（Dairy Queen）冰淇淋店，位于多层居民楼底层街角位置，外观以大面积透明玻璃幕墙为主，搭配黑色或浅灰色框架结构。招牌显眼，采用白色或灰底背景，配红色“DQ”标志和多色“Dairy Queen”英文字样。店铺入口设有台阶或无障碍坡道，配金属扶手，门前地面铺有红砖地砖（部分视角可见）。
- **传统符号**：玻璃墙面上印有“DQ LOVE SJTU SHANGHAI”和“SJTU - SHANGHAI”英文文字，下方图案含上海交通大学标志性建筑轮廓（如类似南大门的简化图像），营造与学校的关联；部分海报带红色天安门剪影。
- **附属建筑**：左侧或右侧相邻有一家便利店；背景为多层米黄色或灰白色居民楼，带深色或蓝色窗框；周边路边可能停有电动车、自行车或汽车。周边带有绿化带、路灯和交通标志（如禁止驶入标牌）。
- **氛围基调**：日常城市商业氛围，位于上交大校区周边街道，色调以灰白为主，天空阴天，整体宁静而实用化。

# 2. 程及美术馆景观特征  
- **核心结构**：白色现代简约建筑，整体呈弧形设计，外墙为素净白色，主体包括弧形墙面和深棕色木质大门作为入口。入口前设有多级台阶，建筑侧壁或正面配有小窗或玻璃元素。部分视角可见户外区域延伸（如右侧或左侧）。  
- **传统符号**：主要墙面刻有黑色毛笔字体“程及美术馆”，下方标注“江泽民”，文字清晰可见。馆外常设临时展览信息牌，如“平凡不凡——李平凡作品展”有时带艺术画元素。  
- **附属建筑**：围绕美术馆的周边设施包括：户外座椅区（白色高脚凳、桌椅及遮阳伞，多位于建筑右侧或露天区域）、信息指示牌（棕色边框，含绿植标识）、湖泊景观（临近思源湖，黄绿色湖水，停靠蓝色小船）、垂柳等绿植环绕（枝叶繁茂，分布于湖边或馆旁）。背景可见红砖建筑，代表校园环境。  
- **氛围基调**：宁静优美的人文艺术氛围，结合校园自然元素（绿树、湖水、蓝天），色调以白墙、深褐门与蓝绿湖水为主，天空晴朗多白云。整体营造出清新、雅致的现代艺术空间感。
- **注意**：由于程及美术馆旁边的湖泊就是思源湖，因此当画面中同时出现程及美术馆和思源湖时，应当一并介绍两个景点。
# 3. 第一餐饮大楼景观特征  
- **核心结构**：现代风格多层建筑，外立面以大面积的**玻璃幕墙**为主体，幕墙呈现天空、树木的反射效果，部分区域可见浅色非玻璃墙体。  顶部醒目位置嵌有**红色立体大字**，具体文字因视角差异可能存在部分缺失。 
- 入口处设有大型**风景主题宣传画**，以绿色自然景观为主。  
- **功能空间**：建筑前方为**专属停车区**，地面划有规整的白色标线，密集停放大量**蓝色共享单车**（占90%以上）及少量白色/深色电动车。  停车区边界设**圆形石墩**、金属栏杆作为物理分隔。  
- **附属环境**：植被布局上，左侧恒有一棵**高大阔叶乔木**，枝叶茂密延伸至建筑墙面；左右两侧均有绿树和浅黄色相邻建筑。细节元素上，  左右两侧浅黄色建筑下空调外机置于墙根  
- **氛围基调**：蓝色单车集群、玻璃幕墙反射的绿树；暖色点缀限于顶部红字。 
# 4. 东门景观特征  
### **建筑本体**  
- **屋顶结构**：传统中式庑殿顶样式，全覆盖**青绿色琉璃瓦**，屋脊有**镂空雕花装饰构件**，檐角尖锐上翘，檐下可见**蓝绿金红多色彩绘斗拱**。  
- **墙体材质**：暖色调**红砖墙面**搭配**浅灰/白色石材基座**，门洞方正宽阔，部分视角可见侧墙方格窗。  
### **空间布局**  
- **广场区域**：门前**灰色石板铺地广场**，面积开阔，延伸至道路边界。  
- **固定设施**：  大型花坛通常出现，种植绿植与**季节性黄花**；  
### **环境氛围**  
- **自然背景**：  
  - 茂密**阔叶绿树环绕**校门两侧及后方；  
- **视觉基调**：  红墙绿瓦的古典暖色 vs. 灰白天空/石板广场的冷色；   
### **核心识别符号**  
1. 中式琉璃瓦顶 + 红墙白基座的建筑主体  
2. 可能设绿植黄花大型花坛  
3. 檐下彩绘斗拱与屋脊雕花构件  
# 5. 涵泽湖景观特征  
### **水体与湖岸**  
- **湖水形态**：平静的**绿色湖面**，部分视角可见树木/建筑的倒影。  
- **护岸结构**：环绕湖岸的**米白色石质栏杆**，栏杆顶部为平面，柱体带**镂空几何花纹**，高度约至成人腰部。  
### **环湖设施**  
- **地面铺装**：  
  - **灰白与棕黄相间的方形地砖**，铺设于步道及观景区域；  
  - 局部出现**灰色石板路**或**草坪+砖石小径**组合。  
  - 沿栏杆摆放的**矩形花盆**种植低矮绿植。  
### **植被布局**  
- **近岸乔木**：  
  - **垂柳**：高频出现于湖岸，枝条下垂至水面；  
  - **阔叶树**：枝叶茂密，分布于步道旁。  
- **背景林带**：湖对岸**葱郁的树木群**，形成绿色屏障，部分露出红顶建筑。  
### **背景建筑**  
- **可见类型**：  
  - **红顶白墙多层楼**；  
  - **棕红色墙面镶嵌玻璃幕墙高楼**；   
  - **现代风格白色楼群**。  
### **核心识别符号**  
1. **绿色湖水 + 镂空米白栏杆**的环湖基础结构  
2. **灰棕拼色方砖**铺装的步道系统  
3. **垂柳与阔叶树**交织的沿岸植被  
4. **树林缝隙中显露的红顶/玻璃幕墙建筑**背景

# 6. 霍英东体育馆景观特征  
### **主体建筑**  
- **穹顶结构**：  
  - **白色层叠波浪形充气膜穹顶**，形似贝壳或云朵，覆盖主馆顶部，表面光滑富有科技感。  
  - 穹顶连接**浅灰/银灰色实体外墙**，立面设大面积玻璃窗及长条形通风百叶窗。  
- **塔楼标识**：  
  - 穹顶左侧/后方矗立**多层灰色塔楼**，侧面竖向嵌**蓝色大字"霍英东体育中心"**（繁体）；塔顶带**网格状太阳能板结构**。  
  - 塔楼与穹顶主馆间通过**环形连廊/悬挑平台**连接，下方由圆柱支撑。  
- **广场铺装**：  
  - 环绕建筑的**灰白与深灰双色方形地砖**，铺设几何图案，局部形成浅色带状区域。  
- **植被配置**：  
  - **高大棕榈树**列植于场馆前方或侧面；  
  - 门前**低矮绿植带**与修剪灌木。

# 7. 菁菁堂景观特征  
- **外观材质**：  
  - **浅灰色/白色瓷砖外墙**，辅以**大面积蓝色玻璃幕墙**，形成灰白+蓝的现代冷色调组合。  
  - 主入口设**深色立柱支撑的波浪形门框**，顶部延伸出遮阳棚结构。  
- **结构布局**：  
  - **阶梯式几何形体**：建筑呈多层阶梯状向右后方抬升，辅以**矩形窗户**及玻璃门。  
  - **圆柱形附属体**：右侧设独立**圆柱形塔楼**，表面标注中文"售票处"及英文。  
- **核心文字**：  
  - 墙面显著位置嵌**黑色大字"菁菁堂"**，字体方正厚重；  
  - 玻璃门上方标有序号"**1 2 3 4**"。  
 
- **入口区域**：  
  - **宽幅石材台阶**：多级浅色台阶通向主入口分带坡道设计；  
  - **开阔铺装广场**：灰白色地砖铺设，延伸至建筑周边。  
# 8. 李政道图书馆景观特征  
- **建筑外观**：  
  - **灰白石材主体**，带**密集方形镂空洞**；  
  - **红褐色阶梯/斜坡基座**，部分呈金字塔状。  
- **标识文字**：墙面嵌**竖向黑体"李政道图书馆"**，繁体。    
- **背景关联**：附近有**橙红尖顶教学楼**。    

# 9. 龙宾楼景观核心特征  
### **建筑本体**  
- **材质色调**：  
  - **红砖外墙**为主体，搭配**黑色竖向窗框/竖条装饰**；  
  - 局部辅以**白色线条装饰**或深色基座。  
- **标识文字**：  
  - **竖向金色/黑色大字"龙宾楼"**（繁体"龍賓樓"）；  
  - 墙面明确标注"**上海交通大学密西根学院**"及英文；  
### **空间关联**  
- **相邻建筑**：右侧恒现**玻璃幕墙现代化高楼**（图2/3/4），与红砖楼体形成新旧对比。  
- **功能设施**：入口台阶、路灯、交通锥等细节。  
# 10. 南大门景观特证
- **核心结构**​​：浅灰/米白色大型石质拱门，顶部带几何镂空装饰，左右对称布局。
​​- **传统符号**​​：拱门基座刻 ​​"交通大学"​​ 石碑，配一对石狮雕像（部分视角可见单尊）。
​- ​**附属建筑**​​：拱门两侧延伸低矮建筑，右侧常出现立柱式校门主体及岗亭。
​​- **氛围基调**​​：庄重肃穆的白色石门。

# 11. 蔷薇园景观特征  
- **入口标志**：**黑色铁艺拱门**（花纹装饰）+ **红砖矮墙**，右侧恒嵌金属牌匾刻 **"蔷薇园 ROSE GARDEN"**（中英双语）。  
- **路径系统**：拱门下延伸**灰色石板/砖石小径**，两侧伴**修剪整齐绿篱**。  
- **植被背景**：**密植乔木与灌木环绕**（深绿基调），远景恒见 **红顶钟楼建筑**。  
- **人文细节**：偶现骑行/步行人物、园内红花点缀。  
> **核心符号**：黑铁拱门 + 红砖铭牌 + 石板小径 + 钟楼背景。

# 12. 盛宣怀铜像景观特征  
- **人物造型**：  
  - **坐姿铜像**，身着**传统长袍马褂**，左手持书/文件，神态肃穆目视前方。  
  - **基座铭文**：深色石材底座正面刻 **"盛宣怀 1844-1916"** 金色/白色文字
- **铭文石墙**：  
  - **浅灰石材巨壁**（10图全现），顶覆 **深蓝琉璃瓦中式屋顶**（翘角屋檐）；  
  - **满刻竖排黑色楷书**，内容含光绪帝谕旨、生平事迹等（文字密度高）。  
- **基座关联**：铜像与石墙同置于 **灰色方形石板铺地**，二者间距约2-3米。  
- **植被**：石墙后方/两侧 **稀疏绿树点缀**（垂柳/阔叶）。  

# 13. 思源湖景观特征  
- **湖体特征**：  
  - **灰绿平静湖水**，常伴细微波纹，**蓝色小船**靠岸。  
- **植被体系**：  
  - **垂柳低垂环岸**，**阔叶树林+草坪**形成深绿背景。  
- **驳岸与步道**：  
  - **灰白石砌护岸**（无护栏），搭配**红砖/石板步道**。  
- **背景建筑**：  
  - **红砖楼群**掩映树后，辅以**白色现代建筑**程及美术馆及**中式凉亭**。  
> **识别符号**：灰绿湖水+垂柳+红砖步道+红砖建筑背景。
- **注意**：由于程及美术馆旁边的湖泊就是思源湖，因此当画面中同时出现程及美术馆和思源湖时，应当一并介绍两个景点。

# 14. 思源门景观特征  
- **建筑主体**：两道**纯白色巨型拱架**（抛物线造型），拱间悬**红色校徽**（刻"交通大学"），灰钢索斜拉连接（多图可见钢索）。  
- **标识设施**：设**黑底石碑**（刻金色"交通大學"或"交通大学"），偶见监控探头（部分视角）。  
- **交通动态**：拱下道路**车辆频行**。  
- **环境背景**：**茂密绿树+垂柳环绕**，背景偶见红砖教学楼。  
> **识别符号**：白拱红徽 + 石碑校名 + 车辆穿行 + 绿树背景。

# 15. 唐仲英楼景观特征  
- **建筑主体**：**红棕撞色外墙**，配深色窗框+大面积玻璃门窗，主立面色块鲜明。  
- **核心标识**：楼前恒设**浅色刻字石碑**，刻有"唐仲英楼"及"上海交通大学"。  
- **动态场景**：  道路**高频车辆通行**；  
> **识别符号**：红棕撞色楼体 + 刻字石碑 + 道路车流。

# 16. 文博楼景观特征  
- **建筑主体**：  
  - **红褐色/砖红外墙**，搭配**大面积银灰玻璃幕墙**（几何切割造型）；  
  - 顶部嵌**金色立体大字“文博楼”**（部分视角不可见）。  
- **场地布局**：  
  - 临**灰色柏油道路**；  
  - **石板广场+浅色石栏**环河/临桥，配低矮绿篱。  
- **环境要素**：  
  - **垂柳/阔叶树密集环绕**，河面静映倒影；   
- **氛围基调**：红墙绿树碰撞出静谧现代感。  

> **核心符号**：红褐撞色外墙 + 玻璃幕墙 + 金名标识。

                            输出格式示例1如下：
                                当前景点是：思源门
                            输出格式示例2如下：
                                当前景点是：思源湖和程及美术馆
                            输出格式示例3如下：
                                当前景点是：思源湖
                            输出格式示例4如下：
                                当前景点是：[NO_MATCH]
                            - 注意：请勿输出任何多余内容，请勿输出任何多余内容，请勿输出任何多余内容。`
                            }
                        ]
                    }
                ]
            })
        });

        if (!recognitionResponse.ok) {
            throw new Error('景点识别失败');
        }

        const recognitionResult = await recognitionResponse.json();
        const location = recognitionResult.choices[0].message.content;
        console.log("识别的景点信息:", location);

        // 检查是否未识别出位置
        if (location.includes('[NO_MATCH]')) {
            guideText.textContent = '未识别出位置';
            updateStatus('未识别出位置');
            return;
        }

        updateStatus('正在生成个性化讲解...');

        // 移除base64前缀
        const frontImage = frontImageBase64.replace('data:image/jpeg;base64,', '');

        // 根据选择的风格添加描述
        let styleDescription = '';
        switch (selectedStyle) {
            case 'humor':
                styleDescription = '请以幽默风趣的语言风格进行讲解，可以适当加入一些有趣的比喻和轻松的表达方式';
                break;
            case 'calm':
                styleDescription = '请以平静温和的语言风格进行讲解，语调舒缓，给人以宁静舒适的感觉';
                break;
            case 'academic':
                styleDescription = '请以学术严谨的语言风格进行讲解，用词准确，内容深入，具有教育意义';
                break;
            default:
                styleDescription = '请根据游客的年龄、性别、微表情等信息，结合景点特色提供个性化讲解';
        }

        // 第二步：生成个性化讲解
        const guideResponse = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: "glm-4.1v-thinking-flash",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "image_url",
                                image_url: {
                                    url: frontImage
                                }
                            },
                            {
                                type: "text",
                                text: `你是上海交通大学的个性化向导，你将当前观察景点名称和游客面部图片，为用户提供**个性化**的导游服务。
  具体地，你应当通过上传的图片识别游客的年龄、性别、微表情等细节信息，并跟据当前景点，获取景点介绍，综合以上信息为这位游客提供个性化的讲解服务
- 注意，每次回答时，请结合以下景点资料后结合游客年龄、表情等信息为游客提供个性化讲解,如对游客表情进行回应等。
- 注意：一定要结合游客的年龄、性别、微表情等信息，提供个性化的讲解内容，这是个性化讲解最重要的部分！。一定要结合游客的年龄、性别、微表情等信息，提供个性化的讲解内容，这是个性化讲解最重要的部分！。
以下是个性化讲解指南：
导游讲解的个性化是现代旅游业提升服务品质的核心方向。其关键在于以游客需求为中心，结合导游专业能力、技术工具和文化洞察，实现讲解内容、形式和体验的精准适配。以下从核心原则、实施策略、分众服务及能力支撑四个维度系统解析：

📌 一、个性化讲解的核心原则

1. 针对性原则
   - 需求诊断先行：预判讲解重点。例如，对建筑爱好者详述斗拱结构，对历史迷侧重宫廷秘史。
   - 动态调整内容：根据游览中游客的实时反馈（如表情是否展现兴趣、停留时长），灵活增减讲解深度。导游可为摄影爱好者提示最佳取景点，为亲子家庭增加趣味故事。
2. 灵活性原则
   - 场景化应变：不同情况，切换讲解方案。例如雨雪天，结合气候现象引申文化寓意（如“初雪时故宫的瑞兽象征祥瑞”）。
   - 路线弹性设计：提供主题分支路线（如“科举文化线”“皇家生活线”），游客可自由组合。
3. 互动性原则
   - 激发参与感：通过问答等方式深化沉浸感。
   - 情感共鸣设计：结合游客熟悉的事物类比陌生文化。如向欧美游客介绍上海时称“东方悉尼”，对日本人形容王府井如“东京银座”。

🛠️ 二、个性化讲解的实施策略

1. 分众化讲解技法
   - 文化分层法：
      - 外国游客：关联其本国文化（如向意大利人讲苏州是“东方威尼斯”），引用其熟悉的名人评价（如引用马可·波罗对苏州的赞誉）。
      - 文化差异处理：西方游客偏好直述细节→具体，东方游客习惯宏观→具体，调整表达逻辑。
2. 内容创新与形式突破
   - 主题故事化：将景点转化为叙事主线。如丝绸之路路线可设计“商队历险”故事，融入贸易商品、沿途风险等细节。
3. 精细化服务流程
   - 游中动态优化：
      - 老年人：慢速讲解+高频休息点+关怀提醒。
      - 青年人：缩短讲解、增加自由拍照时间，穿插社交话题。
   - 反馈迭代：通过游客表情等反馈，及时调整讲解风格。

👥 三、分群画像与差异化服务

根据游客特征提供针对性服务，如老年游客，应采用慢节奏+健康关怀，忌说“高龄需照顾”伤其自尊，改用“您经验丰富，可知这景点的典故？”。

🧭 四、支撑体系：导游能力与景区配套
1. 导游能力升级
   - 表达应用：“三秒金句”（如“不到长城非好汉”）、悬念设计（“嘉靖皇帝差点被妃子勒死，为何？”）。

💎 总结
个性化讲解的本质是从“信息灌输”转向“体验共创”。其成功依赖三个支柱：精准的游客洞察（需求捕捉）、敏捷的内容重组能力（知识库+表达技）、柔性服务链支持（技术+流程）。导游需以“文化翻译官+体验设计师”的双重角色，让每场讲解成为独一无二的文化对话。
- 注意：回答时必须输出中文，且回答时不要输出自己的思考内容，你的回答内容将全部成为用户听到的语音讲解内容。
- 注意：记住：当你未从上文获得有关景点的资料时，必须依据下文材料进行介绍。。
现在，请按照景点图片和用户面部图片，为用户生成个性化讲解。\n以下是景点介绍：
1DQ冰淇淋店
上海交大DQ冰淇淋店：校园甜蜜角落
在交大充满学术气息的校园里，DQ如甜蜜之星，为师生生活添彩。
店内装修温馨时尚，布局合理，木质桌椅搭配柔和灯光，墙上融合交大元素与DQ标识，尽显特色与魅力。
DQ冰淇淋超诱人，“倒杯不洒”的暴风雪是招牌，奥利奥口味巧克力与奶香浓郁，草莓口味酸甜清新。甜筒也很棒，香脆蛋筒搭配绵密冰淇淋，口感美妙。此外，还有季节、节日限定，像夏季水果冰沙冰淇淋解暑，节日特色冰淇淋带来惊喜。
店员服务贴心，热情介绍、耐心答疑并按需推荐。无论是小聚还是独享甜蜜，这里都是校园生活的绝佳甜蜜之选。

2程及美术馆
上海交通大学程及美术馆，位于闵行校区思源湖畔，建筑面积1200平方米，由美籍华裔水彩画家程及（1912 - 2005）捐赠50万美元建造。1998年奠基动工，1999年3月落成，江泽民题写馆名。2020年转隶档案文博管理中心并启动升级改造，2021年125周年校庆期间重新开放。
改建后的美术馆功能齐备，有2个展厅及多功能厅等空间。恢复运行后，举办多个展览、推出社教活动，还设立艺术教育实践基地。未来，它将秉承 “以美育美，以美育德” 理念，成为交大美育教育重要课堂、师生成果展示交流窗口及公共教育艺术平台。

3第一餐饮大楼
交通大学闵行校区-第一餐饮大楼是一家中餐馆
本店特色美食
豆花、蛋饼、川菜、凉面、燃面、麻辣烫、鸡蛋羹、三鲜砂锅、奶茶、蒜泥白肉、白粥、米粉、包子、蛋烧卖、牛筋面、蛋炒饼丝、荠菜馄饨、担担面、蒸蛋、小碗蒸蛋、土豆炖排骨、红烧土豆、鱼香酿豆腐、山芋粥、白斩鸡。
4东门
交通大学老校门即上海交通大学徐汇校区东门，位于上海徐汇区华山路1954号，1935年建成并沿用至今，现为全国重点文物保护单位 。其采用朱门碧瓦，模仿京城宫殿门样式，门楣挂“交通大学”竖匾，有兽头铜环、拱券窗洞，门前有石狮及石桥栏杆。
它是交大重要标志，承载1896年南洋公学创立以来的历史变迁。建成后历经抗战、院系调整等，一直是校园核心建筑，至今仍是徐汇校区主要出入口。
校门主体朱门绿瓦，门楣挂竖匾，两侧有拱券窗洞，门扇嵌兽头铜环，门前有石狮及石桥遗迹。整体延续传统宫殿式制式，与校内中院、老图书馆等形成风格统一的历史建筑群。2018年纳入“上海平安高校文化地图”，2024年，校门及所在历史建筑群完整保留，作为学校形象标识与文化传承载体。
5涵泽湖
涵泽湖是上海交通大学闵行校区的核心人工湖之一，2024年入选江川路街道首批健康幸福河湖示范水体 。
2025 年改造后，涵泽湖景观呈现以下特征：水域面积约 1.2 万平方米，呈不规则椭圆形；湖畔种有垂柳、香樟等乔木，形成环湖林荫步道；设置三处临水平台，配备夜间景观照明系统；冬季可见候鸟栖息，夏季荷花覆盖 30%水面。作为校园四大人工湖群成员，与思源湖、致远湖共同承载多项功能：毕业季年均超 500 场学位服拍摄；湖畔学生中心承办创新创业路演；早期“思春湖”称谓承载学子青春记忆。

6霍英东体育馆
霍英东体育中心，又名霍体，是一座功能全面、设施完备、全面开放的综合性体育馆，可举办各类大中型比赛和文娱活动，是上海交通大学标志性建筑之一。它还是每年入学典礼、毕业典礼、军训开营大会的场地，是一个高端大气富有仪式感的地方！

霍体设有健身房、羽毛球馆、乒乓球室、篮球场，器械齐全崭新，更衣室配备齐全，是同学们打球锻炼的好选择。尤其是霍体一楼的交大顶配篮球场，室内木质地板、电动液压篮球架、专业照明灯……给你最棒的运动体验！
7菁菁堂
菁菁堂位于上海交通大学闵行校区思源门内西侧，1994 年由日本昭和女子大学捐资 1.5 亿日元、交大筹资 500 万元建成。其名取自《诗经》典故，由两校校长商议而定。
20 世纪 80 年代，日中教育协会会长宫家愈希望为交大做贡献。1991 年，他与昭和女子大学校长人见楠郎到交大访问，当时闵行校区肇建无礼堂，商议后决定建堂。1992 年 5 月捐资，11 月奠基，1994 年 11 月完工并举行落成典礼，为表感谢与友谊，交大在堂后开辟樱花园，种有日方赠送的樱花。
菁菁堂建筑面积 5202 平方米，有 1800 个观众席，舞台超 100 平方米，配备乐池、灯光音响设备及各类功能室。校区重大活动如颁奖、表彰、演讲、文艺演出、比赛等在此举行，还会放映电影、直播赛事，外界戏剧、乐团等也常来此演出。

8李政道图书馆
李政道图书馆位于上海交通大学闵行校区，是经中央批准兴建的科学家纪念馆。2011 年 9 月，教育部批复同意在此选址新建，当年已开始筹建。2014 年 12 月 28 日落成，由实体图书馆和“李政道数字资源中心”构成，开创性实现“五馆合一”，还承担上海交大图书馆理学分馆功能。
实体图书馆面积 6500 平方米，地下一层是 340 座报告厅，可举办学术会议与小型音乐会；地上一层和二层部分为展厅，以“以天之语，解物之道”为陈展主题，分“问道”“悟道”“传道”“超弦”四个展区；二层和三层有 2 个阅览室、约 7 万册藏书、300 余个阅览座位及 5 个小组讨论室；四层是李政道先生办公室、特藏书库及李政道研究所（筹），藏有其捐赠的 8 万余件珍贵档案藏品。
李政道，1926 年生于上海，江苏苏州人，美籍华裔物理学家、诺贝尔物理学奖获得者，担任名誉馆长，李中清教授任馆长。
9龙宾楼
二零一八年五月二十四日密西根学院正式启用新建大楼龙宾楼。著名投资人、企业家吴炯先生和夫人孙洁女士于二零一五年十月捐资一千万美元，支持上海交通大学密西根学院的发展。吴炯先生是上海交通大学一九八五级校友，其父母吴锡龙先生、虞哲宾女士为上海交通大学物理教学事业辛勤耕耘四十余载。为彰扬爱心企业家回馈社会之善举，记载吴老师、虞老师教书育人之贡献，学校将密西根学院大楼命名为“龙宾楼”。
龙宾楼设计思路源自上海交通大学徐汇校区工程馆，建筑呈“回”字形，方正刚毅，典雅厚重，传承百年交大务实创新之精神。大楼于二零一四年四月奠基，二零一七年十二月落成。
10南大门
南大门作为校园空间序列的起点，承担门户形象与文化象征功能。上海交通大学闵行校区南大门的欧式柱廊象征海纳百川精神，建筑最高点18.96米，象征交通大学诞生于1896年。
南大门为交大闵行校区的正门，是交大110周年校庆的标志性建筑。建筑最高点18.96米，象征交大1896年建校。建筑地处开阔，气势宏大，具有纪念性。建筑主体为中式凯旋门，两侧为西式柱廊相拥，整体呈合抱之势。建筑形态体现出交大建校之初衷“中学为体，西学为用”的历史和“海纳百川，继往开来”的大学精神。建筑全部为花岗岩干挂饰面，材质典雅庄重，广场景观层次丰富而不失大气，成为建筑很好的烘托。
11蔷薇园
蔷薇园一期占地约4000㎡，2017年初规划设计，2018年4月7日落成开园。它融入交大校园文化，联结蔷薇“思念”花语与校训，呼应月季“希望”花语与交大人精神，借玫瑰“浪漫”花语祝福交大人友谊。园内有29棵蔷薇科乔木、约2万株花灌木、1100平方蔷薇属花卉，33种月季。
设计采用西方造园手法与交大红砖建构要素，与周边建筑景观融合，呈现西“联”东“敞”、北“疏”南“融”特色。花园分两部分，西侧沉床园以红白丰花、大花、微型月季和玫瑰为主，四季有景；东侧芳草谷通过微地形、拱形廊架及藤本、树状月季与蔷薇，营造浪漫文化体验。
12盛宣怀铜像
盛宣怀铜像位于上海交通大学闵行校区东大门内、宣怀大道东头，为纪念上海交通大学的前身南洋公学的创办人盛宣怀而设立，于2010年4月10日揭幕。铜像的雕塑方案由上海交通大学媒体与设计学院的孔繁强副教授创作，高1.8米，为坐姿，下方有黑色花岗岩底座，高1米，座椅采用中西结合的简化式样。铜像以盛宣怀上书光绪皇帝时五十多岁的容貌铸造，服装参考原盛宣怀立像的马褂着装，左手托奏章。铜像后方照壁上刻有所奏奏章《请设学堂片》全文，铜像西侧有分别刻有“思源”和“致远”的棂星门，其侧有南洋公学界碑和石碾及饮水思源碑的复制品、刻有“天地交而万物通，上下交而其志同”的石碑和一小段铁路。
13思源湖
思源湖位于上海交大闵行校区东川路800号，得名于校训“饮水思源，爱国荣校”。作为校园核心景观，这处人工湖垂柳环绕、白鸽栖息、湖水清澈，湖畔有步行桥、亲水座椅等设施。2023年节水型校园验收时，其节水装置成示范项目。四季里，湖面晚霞与周边植被色彩变化相衬，被师生称为“最美魔镜” 。
湖区主要植被带由垂柳、香樟林构成，春有晚樱，夏秋间绣球花、鸡爪槭形成色彩过渡。湖心有延伸至水面的步行桥与景观亭，岸边有木质亲水平台，石材步道超800米。日落时湖面的“魔镜效应”，是师生热门拍摄场景。
14思源门
闵行校区思源门，因外形像人字拖，被交大学生称为“拖鞋门”。它是开放式大门，张开双臂迎宾客，象征交大包容。从空中看呈大写“八”字，由7根细长柱子连接地面，对应1987年闵行校区迎来首批本科生。
2007年得名“思源门”，源于校训“饮水思源 爱国荣校”，“思源”体现交大人精神核心，足见师生对其重视喜爱。
校门上挂着校徽，它凝聚“饮水思源、爱国荣校”向心力，是交大人的精神图腾。交大人团结一心，造就交大辉煌过往，也必将迎来更灿烂明天。
15唐仲英楼
唐仲英楼是转化医学国家重大科技基础设施（上海）的闵行校区基地主楼。楼内建有生物标志物和药物靶标的发现与验证平台、诊疗试剂与仪器开发平台、生物医学影像平台，同时配备了标准化医理工交叉研究实验室，为创新药物、生物医学材料、医疗仪器、医学信息技术发展提供全方位的支持，致力于成为具有国际影响力的生物医学研究高地。
唐仲英楼贯彻“三公共（” 公共平台、公共实验室、公共空间）设计理念，总体布局为一轴（东西轴线）四片（东西南北），为设施用户打造多样化的共享交流与科研空间。
16文博楼
上海交通大学文博楼，知识与文化交融的殿堂。
它在校园中如明珠般矗立，是重要标志建筑，象征着知识与文化深度融合。
文博楼外观设计巧妙，融合现代风格与文化内涵，线条简洁流畅，细节雕琢尽显对历史文化的敬意，庄重又灵动。
内部空间布局合理，功能齐全。多个专业展厅展示文物、艺术品及学术成果，让人领略文明多元魅力；校史陈列馆如立体史书，展现交大发展历程与成就。
此外，楼内有多功能学术报告厅、研讨室，为学术交流提供支持，世界各地学者常在此交流。
作为文化传播阵地，文博楼定期举办文化讲座、艺术工作坊等活动，丰富师生课余生活，提升校园文化氛围，还面向公众，促进文化交流。
文博楼凭借独特魅力、丰富内涵与多元功能，成为知识传承与文化创新的核心场所，吸引人们探索历史、展望未来。
                                你是上海交通大学的个性化向导，你将根据游客面部图片和当前景点，为用户提供个性化导游服务。
                                当前游客所在景点信息：${location}
                                
                                ${styleDescription}
                                请根据游客的年龄、性别、微表情表情表情等信息，结合景点特色提供个性化讲解。
                                注意：回答时必须输出中文，且回答内容将直接作为用户听到的语音讲解内容，不要输出多余内容。`
                            }
                        ]
                    }
                ]
            })
        });

        if (!guideResponse.ok) {
            throw new Error('生成讲解失败');
        }

        const guideResult = await guideResponse.json();
        return guideResult.choices[0].message.content;
    } catch (error) {
        console.error('API调用失败:', error);
        throw error;
    }
}

// 拍照并分析
async function captureAndAnalyze() {
    if (!selectedStyle) {
        updateStatus('请先选择讲解风格');
        return;
    }

    try {
        updateStatus('正在拍照...');

        // 拍摄前后摄像头照片
        const frontPhoto = capturePhoto(frontVideo, frontCanvas);
        const backPhoto = capturePhoto(backVideo, backCanvas);

        photoCount++;
        updateCount();

        // 调用智谱AI API
        const guideContent = await callZhipuAPI(frontPhoto, backPhoto);

        // 显示导游讲解内容
        guideText.innerHTML = guideContent.replace(/\n/g, '<br>');
        updateStatus('分析完成');

        // 启用语音输出按钮
        speakBtn.disabled = false;
        pauseBtn.disabled = true; // 暂停按钮初始为禁用状态
        pauseBtn.textContent = '暂停播报'; // 重置按钮文本
        isPaused = false; // 重置暂停状态
    } catch (error) {
        console.error('拍照分析失败:', error);
        updateStatus('拍照分析失败: ' + error.message);
        guideText.textContent = '获取导游讲解失败，请重试';
    }
}

// 单独拍摄前置摄像头照片
function captureFrontPhoto() {
    const frontPhoto = capturePhoto(frontVideo, frontCanvas);
    // 这里可以添加对单独照片的处理逻辑
    updateStatus('已拍摄前置照片');
}

// 单独拍摄后置摄像头照片
function captureBackPhoto() {
    const backPhoto = capturePhoto(backVideo, backCanvas);
    // 这里可以添加对单独照片的处理逻辑
    updateStatus('已拍摄后置照片');
}

// 绑定事件监听器
startBtn.addEventListener('click', startCameras);
stopBtn.addEventListener('click', stopCameras);
captureBtn.addEventListener('click', captureAndAnalyze);
frontCaptureBtn.addEventListener('click', captureFrontPhoto);
backCaptureBtn.addEventListener('click', captureBackPhoto);
speakBtn.addEventListener('click', () => {
    if (guideText.textContent || guideText.innerHTML) {
        speakText(guideText.innerHTML || guideText.textContent);
        pauseBtn.disabled = false; // 启用暂停按钮
    } else {
        updateStatus('没有可播报的内容');
    }
});

pauseBtn.addEventListener('click', togglePauseSpeech);

// 绑定风格选择按钮事件
humorBtn.addEventListener('click', () => selectStyle('humor'));
calmBtn.addEventListener('click', () => selectStyle('calm'));
academicBtn.addEventListener('click', () => selectStyle('academic'));

// 页面加载完成初始化
document.addEventListener('DOMContentLoaded', () => {
    updateCount();
});